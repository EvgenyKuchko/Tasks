<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</title>
  <style>
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    th, td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
    }
      .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
  }
  .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 30%;
  }
  .close {
      float: right;
      font-size: 28px;
      cursor: pointer;
  }
  </style>
</head>
<body>
<h2>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</h2>

<button id="openTaskModal">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>

<div id="taskModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏</h2>
        <form id="taskForm" method="post" th:action="@{/admin/tasks/create}" th:object="${task}">
            <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" id="title" th:field="*{title}" required>

            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <input type="text" id="description" th:field="*{description}" required>

            <label for="date">–ü–∞—Ä–æ–ª—å:</label>
            <input type="date" id="date" th:field="*{date}" required>

            <label for="username">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:</label>
            <select id="username" th:field="*{username}" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                <option th:each="username : ${usernames}"
                        th:value="${username}"
                        th:text="${username}">
                </option>
            </select>

            <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
        </form>
    </div>
</div>

<form method="get" action="/admin/tasks">
    <label for="keyword">–ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É:</label>
    <input type="text" id="keyword" name="keyword" th:value="${param.keyword}">

    <label for="username">–§–∏–ª—å—Ç—Ä –ø–æ username:</label>
    <select id="usrname" name="username">
        <option value="">–í—Å–µ</option>
        <option th:each="username : ${usernames}"
                th:value="${username}"
                th:text="${username}"
                th:selected="${param.username == username}"></option>
    </select>

    <label for="date">–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ:</label>
    <input type="date" id="dte" name="date" th:value="${param.date}">

    <button type="submit">üîç –ü–æ–∏—Å–∫</button>
    <a href="/admin/tasks">
        <button type="button">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
    </a>
</form>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
        <th>–î–∞—Ç–∞</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>Username</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="task : ${tasks}">
        <td th:text="${task.id}"></td>
        <td th:text="${task.title}"></td>
        <td th:text="${task.description}"></td>
        <td th:text="${task.date}"></td>
        <td th:text="${task.status.displayName}"></td>
        <th th:text="${task.username}"></th>
        <th>
            <button class="openUpdateModel"
                    th:data-task-id="${task.id}"
                    th:data-task-title="${task.title}"
                    th:data-task-description="${task.description}"
                    th:data-task-status="${task.status}"
                    th:data-task-date="${task.date}">
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>

            <form th:action="@{/admin/tasks/{taskId}/complete(taskId=${task.id})}" method="post">
                <button type="submit" onclick="return confirm('–ó–∞–¥–∞—á–∞ –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞?')">
                    –í—ã–ø–æ–ª–Ω–∏—Ç—å
                </button>
            </form>

            <form th:action="@{/admin/tasks/{taskId}/cancel(taskId=${task.id})}" method="post">
                <button type="submit" onclick="return confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É?')">
                    –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
            </form>

            <form th:action="@{/admin/tasks/{taskId}/delete(taskId=${task.id})}" method="post">
                <button type="submit" onclick="return confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')">
                    –£–¥–∞–ª–∏—Ç—å
                </button>
            </form>

        </th>
    </tr>
    </tbody>
</table>

<div id="updateTaskModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h2>
        <form id="updateTaskForm" th:action="@{/admin/tasks/{taskId}/update(taskId=${task.id})}" method="post">
            <input type="hidden" name="taskId" id="updateTaskId">

            <label for="updateTaskTitle">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" name="title" id="updateTaskTitle"> <br><br>

            <label for="updateTaskDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea name="description" id="updateTaskDescription"></textarea> <br><br>

            <label for="updateTaskDate">–î–∞—Ç–∞:</label>
            <input type="date" name="date" id="updateTaskDate"> <br><br>

            <button type="submit">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        // =========================
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
        // =========================
        let taskModal = document.getElementById("taskModal");
        let openTaskModalBtn = document.getElementById("openTaskModal");
        let closeTaskModalBtn = taskModal.querySelector(".close");

        openTaskModalBtn.addEventListener("click", function () {
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º
            document.getElementById("title").value = "";
            document.getElementById("description").value = "";
            document.getElementById("date").value = "";
            document.getElementById("username").value = ""; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

            taskModal.style.display = "block";
        });

        closeTaskModalBtn.addEventListener("click", function () {
            taskModal.style.display = "none";
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è
        window.addEventListener("click", function (event) {
            if (event.target === taskModal) {
                taskModal.style.display = "none";
            }
        });

        // =========================
        // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
        // =========================
        let updateTaskModal = document.getElementById("updateTaskModal");
        let closeUpdateTaskBtn = updateTaskModal.querySelector(".close");

        document.querySelectorAll(".openUpdateModel").forEach(button => {
            button.addEventListener("click", function () {
                let taskId = this.getAttribute("data-task-id");
                let title = this.getAttribute("data-task-title");
                let description = this.getAttribute("data-task-description");
                let date = this.getAttribute("data-task-date");
                let status = this.getAttribute("data-task-status");
                let assignedUser = this.getAttribute("data-task-user"); // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–¥–∞—á–∏

                if (!taskId) {
                    console.error("–û—à–∏–±–∫–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç data-task-id —É –∫–Ω–æ–ø–∫–∏");
                    return;
                }

                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É
                document.getElementById("updateTaskId").value = taskId;
                document.getElementById("updateTaskTitle").value = title;
                document.getElementById("updateTaskDescription").value = description;
                if (date) {
                    document.getElementById("updateTaskDate").value = date;
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
                let statusSelect = document.getElementById("updateTaskStatus");
                if (statusSelect) {
                    let found = false;
                    for (let option of statusSelect.options) {
                        if (option.textContent.trim() === status.trim()) {
                            option.selected = true;
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        console.warn(`–°—Ç–∞—Ç—É—Å ${status} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ`);
                    }
                }

                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                let userSelect = document.getElementById("updateTaskUser");
                if (userSelect) {
                    let userFound = false;
                    for (let option of userSelect.options) {
                        if (option.value.trim() === assignedUser.trim()) {
                            option.selected = true;
                            userFound = true;
                            break;
                        }
                    }
                    if (!userFound) {
                        console.warn(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${assignedUser} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ`);
                    }
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º action —Ñ–æ—Ä–º—ã
                document.getElementById("updateTaskForm").action = `/admin/tasks/${taskId}/update`;

                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                updateTaskModal.style.display = "block";
            });
        });

        closeUpdateTaskBtn.onclick = function () {
            updateTaskModal.style.display = "none";
        };

        window.addEventListener("click", function (event) {
            if (event.target === updateTaskModal) {
                updateTaskModal.style.display = "none";
            }
        });
    });
</script>

</body>
</html>