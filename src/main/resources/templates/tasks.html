<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</title>
  <style>
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    th, td {
        border: 1px solid black;
        padding: 8px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
    }
      .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
  }
  .modal-content {
      background-color: white;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 30%;
  }
  .close {
      float: right;
      font-size: 28px;
      cursor: pointer;
  }
  </style>
</head>
<body>
<h2>–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á</h2>

<button id="openTaskModal">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É</button>

<div id="taskModal" class="modal" th:classappend="${hasErrors} ? 'open' : ''">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞–¥–∞—á–∏</h2>
        <div th:if="${error}" class="error-message" style="color: red;">
            <p th:text="${error}"></p>
        </div>
        <form id="taskForm" method="post" th:action="@{/admin/tasks/create}" th:object="${taskDto}">
            <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" id="title" th:field="*{title}" required>
            <span class="error-message" th:if="${#fields.hasErrors('title')}" th:errors="*{title}" style="color: red;"></span>
            <br><br>

            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <input type="text" id="description" th:field="*{description}" required>
            <span class="error-message" th:if="${#fields.hasErrors('description')}" th:errors="*{description}" style="color: red;"></span>
            <br><br>

            <label for="date">–î–∞—Ç–∞:</label>
            <input type="date" id="date" th:field="*{date}" th:value="*{date}" required>
            <span class="error-message" th:if="${#fields.hasErrors('date')}" th:errors="*{date}" style="color: red;"></span>
            <br><br>

            <label for="username">–ù–∞–∑–Ω–∞—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:</label>
            <select id="username" th:field="*{username}" required>
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</option>
                <option th:each="username : ${usernames}"
                        th:value="${username}"
                        th:text="${username}"
                        th:selected="${username == taskDto.username}">
                </option>
            </select>
            <span class="error-message" th:if="${#fields.hasErrors('username')}" th:errors="*{username}" style="color: red;"></span>

            <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
        </form>

        <input type="hidden" id="validationErrorCreate" th:value="${hasErrors} ? 'true' : 'false'">
    </div>
</div>

<form method="get" action="/admin/tasks">
    <label for="keyword">–ü–æ–∏—Å–∫ –ø–æ –∫–ª—é—á–µ–≤–æ–º—É —Å–ª–æ–≤—É:</label>
    <input type="text" id="keyword" name="keyword" th:value="${param.keyword}">

    <label for="username">–§–∏–ª—å—Ç—Ä –ø–æ username:</label>
    <select id="usrname" name="username">
        <option value="">–í—Å–µ</option>
        <option th:each="username : ${usernames}"
                th:value="${username}"
                th:text="${username}"
                th:selected="${param.username == username}"></option>
    </select>

    <label for="date">–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ:</label>
    <input type="date" id="dte" name="date" th:value="${param.date}">

    <button type="submit">üîç –ü–æ–∏—Å–∫</button>
    <a href="/admin/tasks">
        <button type="button">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
    </a>
</form>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
        <th>–î–∞—Ç–∞</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>Username</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="task : ${tasks}">
        <td th:text="${task.id}"></td>
        <td th:text="${task.title}"></td>
        <td th:text="${task.description}"></td>
        <td th:text="${task.date}"></td>
        <td th:text="${task.status.displayName}"></td>
        <th th:text="${task.username}"></th>
        <th>
            <button class="openUpdateModel"
                    th:data-task-id="${task.id}"
                    th:data-task-title="${task.title}"
                    th:data-task-description="${task.description}"
                    th:data-task-status="${task.status}"
                    th:data-task-date="${task.date}"
                    th:data-task-username="${task.username}">
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>

            <form th:action="@{/admin/tasks/{taskId}/complete(taskId=${task.id})}" method="post">
                <button type="submit" onclick="return confirm('–ó–∞–¥–∞—á–∞ –±—ã–ª–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞?')">
                    –í—ã–ø–æ–ª–Ω–∏—Ç—å
                </button>
            </form>

            <form th:action="@{/admin/tasks/{taskId}/cancel(taskId=${task.id})}" method="post">
                <button type="submit" onclick="return confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–º–µ–Ω–∏—Ç—å –∑–∞–¥–∞—á—É?')">
                    –û—Ç–º–µ–Ω–∏—Ç—å
                </button>
            </form>

            <form th:action="@{/admin/tasks/{taskId}/delete(taskId=${task.id})}" method="post">
                <button type="submit" onclick="return confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')">
                    –£–¥–∞–ª–∏—Ç—å
                </button>
            </form>

        </th>
    </tr>
    </tbody>
</table>

<div id="updateTaskModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h2>

        <div th:if="${error}" class="error-message" style="color: red;">
            <p th:text="${error}"></p>
        </div>

        <form id="updateTaskForm" th:action="@{/admin/tasks/{taskId}/update(taskId=${updateTaskId})}"
              method="post" th:object="${taskDto}">

            <input type="hidden" id="updateTaskId" name="id" th:field="*{id}">
            <input type="hidden" id="updateTaskUsername" name="username" th:field="*{username}">

            <label for="updateTaskTitle">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" name="title" id="updateTaskTitle" th:field="*{title}">
            <span class="error-message" th:if="${#fields.hasErrors('title')}" th:errors="*{title}" style="color: red;"></span>
            <br><br>

            <label for="updateTaskDescription">–û–ø–∏—Å–∞–Ω–∏–µ:</label>
            <textarea name="description" id="updateTaskDescription" th:field="*{description}"></textarea>
            <span class="error-message" th:if="${#fields.hasErrors('description')}" th:errors="*{description}" style="color: red;"></span>
            <br><br>

            <label for="updateTaskDate">–î–∞—Ç–∞:</label>
            <input type="date" name="date" id="updateTaskDate" th:field="*{date}">
            <span class="error-message" th:if="${#fields.hasErrors('date')}" th:errors="*{date}" style="color: red;"></span>
            <br><br>

            <button type="submit">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </form>
        <input type="hidden" id="validationErrorUpdate" th:value="${updateTaskId != null ? 'true' : 'false'}">
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    // =========================
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
    // =========================
    function openModal(modal) {
        modal.style.display = "block";
    }

    function closeModal(modal) {
        modal.style.display = "none";
    }

    function setupModalEvents(openButtonId, modalId, closeButtonSelector, errorInputId) {
        let modal = document.getElementById(modalId);
        let openButton = document.getElementById(openButtonId);
        let closeButton = modal.querySelector(closeButtonSelector);
        let validationError = document.getElementById(errorInputId)?.value;

        if (openButton) {
            openButton.addEventListener("click", function () {
                if (validationError !== "true") {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ ‚Äî –æ—á–∏—â–∞–µ–º –ø–æ–ª—è, –∫—Ä–æ–º–µ date –∏ username
                    modal.querySelectorAll("input, textarea, select").forEach(input => {
                        if (input.type !== "hidden" && input.id !== "updateTaskDate" && input.id !== "username") {
                            input.value = "";
                        }
                    });
                }
                openModal(modal);
            });
        }

        if (closeButton) {
            closeButton.addEventListener("click", function () {
                closeModal(modal);
            });
        }

        // –ï—Å–ª–∏ –±—ã–ª–∏ –æ—à–∏–±–∫–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ
        if (validationError === "true") {
            openModal(modal);
        }
    }

    // =========================
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
    // =========================
    setupModalEvents("openTaskModal", "taskModal", ".close", "validationErrorCreate");

    // =========================
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏
    // =========================
    setupModalEvents("openUpdateTaskModal", "updateTaskModal", ".close", "validationErrorUpdate");

    document.querySelectorAll(".openUpdateModel").forEach(button => {
        button.addEventListener("click", function () {
            let taskId = this.getAttribute("data-task-id");
            let title = this.getAttribute("data-task-title");
            let description = this.getAttribute("data-task-description");
            let date = this.getAttribute("data-task-date");
            let username = this.getAttribute("data-task-username");

            document.getElementById("updateTaskId").value = taskId;
            document.getElementById("updateTaskTitle").value = title;
            document.getElementById("updateTaskDescription").value = description;
            document.getElementById("updateTaskDate").value = date;
            document.getElementById("updateTaskUsername").value = username;

            let updateForm = document.getElementById("updateTaskForm");
            updateForm.setAttribute("action", `/admin/tasks/${taskId}/update`);
            openModal(document.getElementById("updateTaskModal"));
        });
    });

    document.getElementById("updateTaskForm").addEventListener("submit", function (event) {
        let hasErrors = document.querySelector(".error-message[style='color: red;']");
        if (!hasErrors) {
            closeModal(document.getElementById("updateTaskModal"));
        }
    });
});
</script>

<a th:href="@{/admin}">–ö —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞–¥–º–∏–Ω–∞</a>
</body>
</html>