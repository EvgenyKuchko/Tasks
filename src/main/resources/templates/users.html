<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
          .modal {
          display: none;
          position: fixed;
          z-index: 1;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0,0,0,0.4);
      }
      .modal-content {
          background-color: white;
          margin: 15% auto;
          padding: 20px;
          border: 1px solid #888;
          width: 30%;
      }
      .close {
          float: right;
          font-size: 28px;
          cursor: pointer;
      }
    </style>
</head>
<body>

<h2>–°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>

<div th:if="${error}" class="error-message" style="color: red;">
    <p th:text="${error}"></p>
</div>

<button id="openUserModal">–°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>

<div id="userModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <form id="userForm" method="post" th:action="@{/admin/users/create}" th:object="${userDto}">
            <label for="firstName">–ò–º—è:</label>
            <input type="text" id="firstName" th:field="*{firstName}" required>
            <span class="error-message" th:if="${#fields.hasErrors('firstName')}" th:errors="*{firstName}" style="color: red;"></span>
            <br><br>

            <label for="username">–õ–æ–≥–∏–Ω:</label>
            <input type="text" id="username" th:field="*{username}" required>
            <span class="error-message" th:if="${#fields.hasErrors('username')}" th:errors="*{username}" style="color: red;"></span>
            <br><br>

            <label for="password">–ü–∞—Ä–æ–ª—å:</label>
            <input type="password" id="password" th:field="*{password}" required>
            <span class="error-message" th:if="${#fields.hasErrors('password')}" th:errors="*{password}" style="color: red;"></span>

            <button type="submit">–°–æ–∑–¥–∞—Ç—å</button>
        </form>
    </div>
</div>

<!-- –§–æ—Ä–º–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ -->
<form method="get" action="/admin/users">
    <label for="username">–ü–æ–∏—Å–∫ –ø–æ –ª–æ–≥–∏–Ω—É:</label>
    <input type="text" id="usrname" name="username" th:value="${param.username}">

    <label for="role">–§–∏–ª—å—Ç—Ä –ø–æ —Ä–æ–ª–∏:</label>
    <select id="role" name="role">
        <option value="">–í—Å–µ</option>
        <option th:each="role : ${allRoles}"
                th:value="${role}"
                th:text="${role}"
                th:selected="${param.role == role}"></option>
    </select>

    <button type="submit">üîç –ü–æ–∏—Å–∫</button>
    <a href="/admin/users">
        <button type="button">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
    </a>
</form>

<table>
    <thead>
    <tr>
        <th>ID</th>
        <th>–ò–º—è</th>
        <th>–õ–æ–≥–∏–Ω</th>
        <th>–†–æ–ª–∏</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="user : ${users}">
        <td th:text="${user.id}"></td>
        <td th:text="${user.firstName}"></td>
        <td th:text="${user.username}"></td>
        <td>
            <span th:each="role : ${user.roles}" th:text="${role} + ' '"></span>
        </td>
        <td>
            <button class="editUserBtn"
                    th:data-user-id="${user.id}"
                    th:data-user-firstname="${user.firstName}"
                    th:data-user-username="${user.username}">
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <form th:action="@{/admin/users/{userId}(userId=${user.id})}" method="post">
                <button type="submit"
                        onclick="return confirm('–£–¥–∞–ª–∏—Ç—å\–î–æ–±–∞–≤–∏—Ç—å —Ä–æ–ª—å –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')">
                    –ê–¥–º–∏–Ω
                </button>
            </form>
            <form th:action="@{/admin/users/{userId}/delete(userId=${user.id})}" method="post">
                <button type="submit" onclick="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')">
                    –£–¥–∞–ª–∏—Ç—å
                </button>
            </form>
        </td>
    </tr>
    </tbody>
</table>

<div id="updateUserModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>

        <form id="updateUserForm" th:action="@{/admin/users/{userId}/update(userId=0)}" method="post" th:object="${userDto}">
            <input type="hidden" name="userId" id="updateUserId">

            <label>–ò–º—è:</label>
            <input type="text" name="firstName" id="updateUserFirstName" required>
            <span class="error-message" th:if="${#fields.hasErrors('firstName')}" th:errors="*{firstName}" style="color: red;"></span>
            <br><br>

            <label>–õ–æ–≥–∏–Ω:</label>
            <input type="text" name="username" id="updateUserUsername" required>
            <span class="error-message" th:if="${#fields.hasErrors('username')}" th:errors="*{username}" style="color: red;"></span>
            <br><br>

            <label>–ü–∞—Ä–æ–ª—å:</label>
            <input type="password" name="password" id="updateUserPassword">
            <span class="error-message" th:if="${#fields.hasErrors('password')}" th:errors="*{password}" style="color: red;"></span>
            <br><br>

            <button type="submit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
      let userModal = document.getElementById("userModal");
      let openUserBtn = document.getElementById("openUserModal");
      let closeUserBtn = userModal.querySelector(".close");

      openUserBtn.onclick = function() {
        userModal.style.display = "block";
      };
      closeUserBtn.onclick = function() {
        userModal.style.display = "none";
      };

      window.onclick = function(event) {
        if (event.target === userModal) {
          userModal.style.display = "none";
        }
      };

      let updateModal = document.getElementById("updateUserModal");
      let closeUpdateBtn = updateModal.querySelector(".close");
      let updateUserForm = document.getElementById("updateUserForm");
      let passwordField = document.getElementById("updateUserPassword");

      document.querySelectorAll(".editUserBtn").forEach(button => {
        button.addEventListener("click", function() {
          let userId = this.getAttribute("data-user-id");
          let firstName = this.getAttribute("data-user-firstname");
          let username = this.getAttribute("data-user-username");

          document.getElementById("updateUserId").value = userId;
          document.getElementById("updateUserFirstName").value = firstName;
          document.getElementById("updateUserUsername").value = username;

          updateUserForm.setAttribute("action", `/admin/users/${userId}/update`);

          // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
          passwordField.value = "";
          passwordField.dataset.originalValue = ""; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ

          updateModal.style.display = "block";
        });
      });

      closeUpdateBtn.onclick = function() {
        updateModal.style.display = "none";
      };

      window.onclick = function(event) {
        if (event.target === updateModal) {
          updateModal.style.display = "none";
        }
      };

      document.addEventListener("keydown", function(event) {
        if (event.key === "Escape") {
          userModal.style.display = "none";
          updateModal.style.display = "none";
        }
      });

      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      updateUserForm.addEventListener("submit", function(event) {
        if (!passwordField.value.trim()) {
          passwordField.removeAttribute("name"); // –£–¥–∞–ª—è–µ–º –ø–æ–ª–µ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞, –µ—Å–ª–∏ –ø—É—Å—Ç–æ–µ
        }
      });
    });
</script>

<a th:href="@{/admin}">–ö —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∞–¥–º–∏–Ω–∞</a>
</body>
</html>